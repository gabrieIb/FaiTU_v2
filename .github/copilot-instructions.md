Purpose

Quick orientation for AI agents working on the collaborative weekly menu planner.

Architecture snapshot

- Android client (`android-app/`, Kotlin + Jetpack Compose) talks to a Google Apps Script backend via HTTPS. No Firebase/Sheets SDK; we make REST calls to `/exec` endpoints.
- Backend logic lives in `apps-script/Code.gs`: executes inside the shared spreadsheet, manipulates tabs `Dishes`, `Ingredients`, `Pantry`, `MenuPlan`, `ShoppingList`, `Users`, and regenerates the shopping list when menu/pantry change.
- Data contract and Google Sheets layout captured in `docs/data-schema.md`. CSV templates under `sheets-template/` seed the spreadsheet.

Key workflows

- Build the app from Windows PowerShell with `cd android-app; .\gradlew.bat assembleDebug`. Run instrumentation tests with `cd android-app; .\gradlew.bat connectedAndroidTest` (requires emulator/device).
- Launch the debug APK via Android Studio or `adb install`. First screen is the Config tab: paste the Apps Script URL (ending `/exec`), API token (Script Property `MENU_API_TOKEN`), and Spreadsheet ID.
- Apps Script deploy: open the sheet → Extensions → Apps Script, paste `apps-script/Code.gs`, add the token property, Deploy → Web app (`Execute as: Me`, `Anyone with the link`). See `docs/apps-script-setup.md` for step-by-step.

Coding patterns to respect

- Android: Compose-first UI (`MainActivity.kt`, `ui/theme`). State flows from `MenuViewModel` (collects `MenuRepository.state`). Network layer is `data/MenuApiClient.kt` using OkHttp. Keep all network calls off the main thread (leverage coroutines in repository/viewmodel).
- Configuration persists via DataStore (`AppConfigRepository`), so any new preference must map to a `preferencesKey` and flow updates back through `ServiceLocator`.
- Apps Script utilities expect ISO timestamps and UUIDs generated by the client (`MenuRepository.nowIso()` / `createUuid()`). When adding new write operations, update `Code.gs` to keep sheet headers in sync and re-run `regenerateShoppingList()` when menu/pantry data mutate.
- Shopping list regeneration is server-side only. If you add client-side mutators, always call `regenerateShoppingList()` (or invoke the `saveMenuEntry`/`updatePantry` endpoints) to keep sheets consistent.

External dependencies & auth

- No Google Cloud project is required; the script runs with the owner's Drive permissions. The only credential is the script property token passed as `?token=` (GET) or in the JSON body (POST). Never hardcode the token in source; keep it in DataStore/config UI.
- HTTP contract: GET `action=listState` returns `{ dishes, menu, pantry, shopping }`. POSTs accept `{ action, token, payload }`. Mirror existing helpers in `MenuApiClient` when adding new endpoints.

Testing & verification

- Use the sheet templates to reproduce data locally. For backend changes, hit the Apps Script URL with `?action=listState&token=...` to inspect responses before updating the client.
- Android unit tests live under `android-app/app/src/test/`. Instrumentation tests go in `android-app/app/src/androidTest/`. Prefer coroutine TestDispatchers when adding repository/viewmodel tests.

Common pitfalls

- Spreadsheet headers are treated as source of truth. If you rename columns, update both `Code.gs` and the CSV templates; otherwise JSON parsing breaks.
- Apps Script quotas are generous but not infinite. Batch writes (`appendRow`, `updateRow`) where possible, and avoid per-row deployments from the client.
- When modifying `MenuApiClient`, keep JSON parsing tolerant (use `optString/optDouble`) to avoid crashes if sheets contain blanks.

How to extend safely

- Add new screens by creating composables under `ui/` and routing via the bottom navigation in `MainActivity`. Share state via `MenuViewModel`; don't expose repositories directly to the UI.
- Backend changes should be versioned: copy updated `Code.gs` here, redeploy via Apps Script, and document the new endpoint in `docs/apps-script-setup.md`.

Reach out

- If behaviour diverges from expectations, confirm the sheet tabs still match `docs/data-schema.md` and that the Config tab in-app points to the latest deployment.