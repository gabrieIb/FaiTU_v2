# Firestore Data Schema

The app now uses Firebase Firestore as the single source of truth. Each household owns a document at `households/{householdId}` plus three nested collections that mirror the legacy Sheets tabs. All timestamps are stored as ISO-8601 strings generated by the client, while `serverTimestamp()` is used for invite metadata.

## Top-level document: `households/{householdId}`

| Field | Type | Description |
| --- | --- | --- |
| `inviteCode` | string | Six-character code used to share access with another device. |
| `createdAt` | server timestamp | Populated when the household is created. |
| `members` | array&lt;string&gt; | Firebase Auth UIDs that belong to the household. Anonymous users are supported. |

### Subcollection: `proposals`

| Field | Type | Notes |
| --- | --- | --- |
| `proposalId` | string | UUID generated on the client (also document ID). |
| `mealSlot` | string | User-facing label (e.g. `Pranzo`, `Cena`). |
| `title` | string | Meal idea/title. |
| `notes` | string|null | Optional free-form notes; stored as `null` when empty. |
| `createdBy` | string | Friendly author label. |
| `createdAt` | string | ISO timestamp from `MenuRepository.nowIso()`. |
| `updatedAt` | string | ISO timestamp updated on every change. |

### Subcollection: `ingredients`

| Field | Type | Notes |
| --- | --- | --- |
| `ingredientId` | string | UUID (document ID). |
| `proposalId` | string | References the parent proposal. |
| `name` | string | Ingredient description as shown in the app. |
| `needToBuy` | boolean | `true` if it should appear in the shopping list. |
| `updatedAt` | string | ISO timestamp updated whenever the ingredient changes. |

### Subcollection: `shopping`

| Field | Type | Notes |
| --- | --- | --- |
| `shoppingId` | string | UUID or mirrors the linked ingredientId. |
| `ingredientId` | string|null | Present for auto-generated entries, `null` for manual notes added from the app. |
| `proposalId` | string|null | Links back to the originating proposal when available. |
| `name` | string | Item label. |
| `status` | string | Currently always `pending`; hooks are in place if we want to add states. |
| `updatedAt` | string | ISO timestamp set on write. |

## Shopping list derivation

- Firestore stores manual shopping notes in the `shopping` collection.
- The Android client listens to both `ingredients` and `shopping`. Manual entries come straight from Firestore, while ingredients marked `needToBuy = true` are mapped locally into temporary `ShoppingEntry` objects so the UI can render a combined list.
- If you deploy the optional Cloud Functions in `functions/`, they will keep the Firestore `shopping` collection in sync with ingredients as well. The client filters out those auto-generated entries (they carry a non-null `ingredientId`) to avoid duplicates when the function is active.

## Invite codes & membership

- `HouseholdRepository` creates households with a six-character invite code stored alongside the members array.
- Joining a household uses a Firestore query on `inviteCode` and appends the caller UID to `members`.
- Security rules (see `docs/firestore-security-rules.md`) ensure that only authenticated members can read/write a given household.

## Housekeeping

- ISO timestamps originate from `MenuRepository.nowIso()`; keep client and server clocks reasonably in sync.
- UUIDs are produced via `MenuRepository.createUuid()` (random v4).
- Offline persistence is enabled: Firestore caches writes locally and synchronises when connectivity returns.
